"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Workspace=void 0;const react_1=__importDefault(require("react")),mobx_react_lite_1=require("mobx-react-lite"),page_1=__importDefault(require("./page")),rules_1=require("./rules"),hotkeys_1=require("./hotkeys"),l10n_1=require("../utils/l10n"),limit=(e,t,r)=>Math.max(t,Math.min(r,e)),ZERO_SIZE_WARNING="Polotno warning: <Workspace /> component can not automatically detect its size.\nWidth or height of parent elements is equal 0.\nPlease make sure it has non-zero size. You may need to adjust it with your styles. <Workspace /> will automatically fit into parent container.\nFor simpler debugging here is the log of the parent element:",useSaveScrollOnScaleChange=(e,t,r,a,l)=>{const o=react_1.default.useRef({width:t,height:r}),n=react_1.default.useRef({top:0,left:0});react_1.default.useEffect((()=>{const t=e.current,r=e=>{n.current={top:t.scrollTop,left:t.scrollLeft}};return t.addEventListener("scroll",r),()=>{t.removeEventListener("scroll",r)}}),[]),react_1.default.useLayoutEffect((()=>{if(!e.current)return;const a=e.current,l=(n.current.left+a.offsetWidth/2)/o.current.width,s=(n.current.top+a.offsetHeight/2)/o.current.height;a.scrollLeft=l*t-a.offsetWidth/2,a.scrollTop=s*r-a.offsetHeight/2,o.current={width:t,height:r}}),[a,t,r])},useScrollOnActiveChange=(e,t,r)=>{const a=react_1.default.useRef(!1),l=react_1.default.useRef(null);react_1.default.useEffect((()=>{const t=e.current,r=()=>{a.current=!0,clearTimeout(l.current),l.current=setTimeout((()=>{a.current=!1}),300)};return t.addEventListener("scroll",r),()=>{t.removeEventListener("scroll",r)}}),[]);const o=r.pages.indexOf(r.activePage);react_1.default.useLayoutEffect((()=>{if(!r.activePage)return;if(!e.current)return;if(a.current)return;const l=e.current,o=r.pages.indexOf(r.activePage)*t;Math.abs(o-l.scrollTop)>.9*t&&(l.scrollTop=o)}),[r.activePage,o])},NoPages=({store:e})=>react_1.default.createElement("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",textAlign:"center"}},react_1.default.createElement("p",null,(0,l10n_1.t)("workspace.noPages")),react_1.default.createElement("button",{onClick:()=>{e.addPage()}},(0,l10n_1.t)("workspace.addPage")));exports.Workspace=(0,mobx_react_lite_1.observer)((({store:e,pageControlsEnabled:t,backgroundColor:r,pageBorderColor:a,activePageBorderColor:l,components:o})=>{const[n,s]=react_1.default.useState({width:100,height:100}),c=react_1.default.useRef(n),i=react_1.default.useRef(null),u=react_1.default.useRef(null),d=e.bleedVisible?Math.max(0,...e.pages.map((e=>e.bleed))):0,h=Math.max(...e.pages.map((e=>e.computedWidth))),f=Math.max(...e.pages.map((e=>e.computedHeight))),g=h+2*d,p=f+2*d,_=()=>{if(null===i.current)return;const t=i.current.getBoundingClientRect();0!==t.width&&0!==t.height||(console.warn(ZERO_SIZE_WARNING),console.log(i.current));const r=u.current.clientWidth||t.width,a={width:r,height:t.height};(c.current.width!==a.width||c.current.height!==a.height)&&(s(a),c.current=a);const l=(r-40)/g,o=(t.height-110)/p,n=Math.max(Math.min(l,o),.01);e.scaleToFit!==n&&(e.setScale(n),e._setScaleToFit(n))};react_1.default.useEffect(_,[g,p]),react_1.default.useEffect((()=>{const e=i.current;if(window.ResizeObserver){const t=new ResizeObserver(_);return t.observe(e),()=>t.unobserve(e)}{const e=setInterval(_,100);return()=>clearInterval(e)}}),[g,p]);const m=Math.max(20,(n.width-g*e.scale)/2),v=p*e.scale*e.pages.length,w=Math.max(55,(n.height-v)/e.pages.length/2);react_1.default.useEffect((()=>{const t=t=>{(0,hotkeys_1.handleHotkey)(t,e)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)}),[]),react_1.default.useEffect((()=>{var t;const r=t=>{if(t.ctrlKey||t.metaKey){t.preventDefault();const o=Math.max(2,e.scaleToFit),n=Math.min(.5,e.scaleToFit),s=(r=t.deltaY>0?1.05*e.scale:e.scale/1.05,a=n,l=o,Math.max(a,Math.min(l,r)));e.setScale(s)}else var r,a,l};return null===(t=u.current)||void 0===t||t.addEventListener("wheel",r),()=>{var e;return null===(e=u.current)||void 0===e?void 0:e.removeEventListener("wheel",r)}}),[]);useSaveScrollOnScaleChange(u,g*e.scale+2*m,p*e.scale+2*w,e.scale),useScrollOnActiveChange(u,p*e.scale+2*w,e);const E=n.width>=g*e.scale+2*m,x=r||"#e8e8e8",b=e.pages.indexOf(e.activePage),y=(null==o?void 0:o.NoPages)||NoPages;return react_1.default.createElement("div",{ref:i,style:{width:"100%",height:"100%",position:"relative",outline:"none",flex:1,backgroundColor:x},tabIndex:0,className:"polotno-workspace-container"},react_1.default.createElement("div",{ref:u,onScroll:t=>{const r=t.currentTarget.childNodes[0].offsetHeight,a=t.currentTarget.scrollTop,l=Math.floor((a+n.height/2)/r),o=e.pages[l];o&&o.select()},style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",overflow:"auto",overflowX:E?"hidden":"auto"},className:"polotno-workspace-inner"},e.pages.map(((r,n)=>Math.abs(n-b)<=1||r._exporting?react_1.default.createElement(page_1.default,{key:r.id,page:r,xPadding:m,yPadding:w,width:g*e.scale+2*m,height:p*e.scale+2*w,store:e,pageControlsEnabled:t,backColor:x,pageBorderColor:a||"lightgrey",activePageBorderColor:l||"rgb(0, 161, 255)",components:o}):react_1.default.createElement("div",{key:r.id,style:{width:g*e.scale+2*m+"px",height:p*e.scale+2*w+"px"}}))),e.rulesVisible&&react_1.default.createElement(rules_1.TopRules,{store:e,xPadding:m,yPadding:w,width:g*e.scale+2*m,height:p*e.scale+2*w}),0===e.pages.length&&react_1.default.createElement(y,{store:e})))})),exports.default=exports.Workspace;